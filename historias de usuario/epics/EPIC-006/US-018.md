# US-018: Sincronización, validación y registro de autorizaciones

**Épica:** [EPIC-006](EPIC-006.md) - Autorizaciones de consulta de datos

## Historia de usuario
**Como** sistema  
**Quiero** sincronizar automáticamente los controles de autorización y validar las decisiones del ciudadano  
**Para** garantizar coherencia entre pregunta global, switches y checkboxes, y registrar correctamente todas las decisiones

## Descripción funcional
El paso de autorizaciones incluye tres niveles de controles interrelacionados que deben mantener sincronización automática:

1. **Pregunta global** (radiobutton Sí/No)
2. **Switches generales** por bloque (uno para "salvo oposición", otro para "únicamente si consiente")
3. **Checkboxes individuales** por cada dato

El sistema debe:
- Mantener sincronización bidireccional entre todos los niveles
- Validar que se haya respondido la pregunta global (obligatorio)
- Validar que se haya completado el motivo si hay oposiciones (obligatorio)
- Registrar todas las decisiones para determinar documentos obligatorios
- Propagar el impacto al Paso 4 (Documentos)

## Criterios de aceptación

### Sincronización de controles

### CA-1: Sincronización pregunta global → switches y checkboxes
**Dado** que el ciudadano cambia la respuesta de la pregunta global  
**Cuando** selecciona Sí o No  
**Entonces** el sistema debe:
- Actualizar todos los switches según corresponda
- Actualizar todos los checkboxes según corresponda
- Mantener coherencia en toda la pantalla

### CA-2: Sincronización switch → checkboxes
**Dado** que el ciudadano activa o desactiva un switch general  
**Cuando** cambia su estado  
**Entonces** el sistema debe marcar o desmarcar TODOS los checkboxes del bloque correspondiente

### CA-3: Sincronización checkboxes → switch
**Dado** que el ciudadano modifica checkboxes individuales  
**Cuando** todos los checkboxes de un bloque quedan en el mismo estado  
**Entonces** el switch general debe reflejar ese estado (activado si todos marcados, desactivado si todos desmarcados)

### CA-4: Sincronización parcial checkboxes → switch
**Dado** que algunos checkboxes están marcados y otros no en un mismo bloque  
**Cuando** el ciudadano los modifica  
**Entonces** el switch debe mostrar estado indeterminado o desactivado

### Validaciones

### CA-5: Validación de pregunta global obligatoria
**Dado** que el ciudadano no ha respondido la pregunta global  
**Cuando** intenta continuar al siguiente paso  
**Entonces** el sistema debe:
- Impedir el avance
- Mostrar mensaje de validación: "Debes responder si autorizas la consulta de datos"
- Resaltar la pregunta global

### CA-6: Validación de motivo obligatorio con oposiciones
**Dado** que hay al menos un dato marcado como oposición y el motivo está vacío  
**Cuando** el ciudadano intenta continuar al siguiente paso  
**Entonces** el sistema debe:
- Impedir el avance
- Mostrar mensaje de validación: "Debes indicar el motivo de la oposición"
- Resaltar el campo de motivo

### CA-7: Permitir continuar con validaciones cumplidas
**Dado** que el ciudadano ha respondido la pregunta global y completado el motivo (si hay oposiciones)  
**Cuando** intenta continuar al siguiente paso  
**Entonces** el sistema debe permitir el avance independientemente de su respuesta (Sí o No)

### Registro y persistencia

### CA-8: Registro completo de decisiones
**Dado** que el ciudadano completa el paso de autorizaciones  
**Cuando** avanza al siguiente paso  
**Entonces** el sistema debe registrar:
- Respuesta a pregunta global
- Para cada dato del bloque 1: si hay oposición o no
- Motivo de la oposición (si existe)
- Para cada dato del bloque 2: si está autorizado o no
- Timestamp de la decisión

### CA-9: Impacto en paso de documentos
**Dado** que el ciudadano finalizó el paso de autorizaciones  
**Cuando** accede al paso de documentos  
**Entonces** los documentos relacionados con datos no autorizados u opuestos deben aparecer como obligatorios

### CA-10: Inclusión en la solicitud
**Dado** que el ciudadano envía la solicitud  
**Cuando** el sistema genera el payload  
**Entonces** debe incluir:
- Autorizaciones "por Ley" (automáticas)
- Autorizaciones "salvo oposición" con estado y motivo
- Autorizaciones "únicamente si consiente" con estado
