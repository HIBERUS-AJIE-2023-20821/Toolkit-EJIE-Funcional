# US-017: Gestión de oposición selectiva a consulta de datos

**Épica:** [EPIC-006](EPIC-006.md) - Autorizaciones de consulta de datos

## Historia de usuario
**Como** ciudadano  
**Quiero** poder oponerme selectivamente a que la Administración consulte ciertos datos  
**Para** controlar qué información autorizo y aportar yo mismo la documentación de los datos a los que me opongo

## Descripción funcional
El **Bloque "Datos salvo oposición"** permite al ciudadano gestionar su oposición a la consulta de datos que por defecto están autorizados. El bloque incluye:

- Un **switch general** que marca/desmarca todos los checkboxes del bloque
- Un **checkbox individual** por cada dato que puede ser consultado
- **Comportamiento**: Si el checkbox está marcado → el ciudadano SE OPONE a la consulta de ese dato
- Si el checkbox está desmarcado → el ciudadano NO se opone (autoriza la consulta)

El ciudadano puede:
1. Usar el switch general para oponerse a todos o a ninguno
2. Marcar/desmarcar checkboxes individuales para ajustar su decisión
3. Especificar el motivo de su oposición en un textarea (obligatorio si hay oposición)
4. Ver claramente qué datos deberá aportar si se opone

Si se opone a algún dato, debe indicar el motivo y los documentos relacionados aparecerán como obligatorios en el Paso 4.

## Criterios de aceptación

### CA-1: Switch general del bloque
**Dado** que el bloque "Datos salvo oposición" está habilitado  
**Cuando** el ciudadano activa el switch general  
**Entonces** el sistema debe marcar TODOS los checkboxes del bloque (se opone a todos)

### CA-2: Desactivar switch general
**Dado** que el switch general está activado  
**Cuando** el ciudadano lo desactiva  
**Entonces** el sistema debe desmarcar TODOS los checkboxes del bloque (no se opone a ninguno)

### CA-3: Oposición selectiva individual
**Dado** que el bloque está habilitado  
**Cuando** el ciudadano marca un checkbox individual  
**Entonces** el sistema debe:
- Registrar que se opone a la consulta de ese dato específico
- Mostrar mensaje informativo indicando que deberá aportar documentación relacionada

### CA-4: Sincronización del switch general
**Dado** que el ciudadano modifica checkboxes individuales  
**Cuando** todos los checkboxes quedan marcados  
**Entonces** el switch general debe activarse automáticamente

### CA-5: Desincronización del switch general
**Dado** que el switch general está activado (todos los checkboxes marcados)  
**Cuando** el ciudadano desmarca al menos un checkbox individual  
**Entonces** el switch general debe desactivarse automáticamente

### CA-6: Mensaje informativo
**Dado** que el ciudadano marca oposición a algún dato  
**Cuando** marca el checkbox de oposición  
**Entonces** debe visualizar un mensaje informativo: "Deberás aportar la documentación cuya consulta no autorices"

### CA-7: Mostrar textarea de motivo
**Dado** que el ciudadano marca oposición a uno o más datos  
**Cuando** marca al menos un checkbox de oposición  
**Entonces** el sistema debe mostrar un textarea con la etiqueta "Motivo de la oposición" (campo obligatorio)

### CA-8: Ocultar textarea de motivo
**Dado** que el textarea de motivo está visible  
**Cuando** el ciudadano desmarca todos los checkboxes de oposición  
**Entonces** el sistema debe ocultar el textarea de motivo

### CA-9: Validación de motivo obligatorio
**Dado** que hay al menos un dato marcado como oposición  
**Cuando** el ciudadano intenta continuar al siguiente paso sin completar el motivo  
**Entonces** el sistema debe mostrar un mensaje de validación: "Debes indicar el motivo de la oposición"

### CA-10: Registro de oposiciones y motivo
**Dado** que el ciudadano ha marcado oposiciones  
**Cuando** continúa con la tramitación  
**Entonces** el sistema debe registrar para cada dato si hay oposición o no

### CA-11: Documentación obligatoria
**Dado** que el ciudadano se opuso a la consulta de uno o más datos  
**Cuando** accede al paso de documentos  
**Entonces** los documentos relacionados con esos datos deben aparecer como obligatorios
