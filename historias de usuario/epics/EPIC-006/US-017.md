# US-017: Gestión de oposiciones y autorizaciones por autorización

**Épica:** [EPIC-006](EPIC-006.md) - Autorizaciones de consulta de datos

## Historia de usuario
**Como** ciudadano  
**Quiero** gestionar selectivamente mis oposiciones y autorizaciones para cada autorización  
**Para** controlar qué información autorizo consultar a la Administración y aportar yo mismo la documentación de las autorizaciones que no conceda

## Descripción funcional
Una vez habilitados los bloques mediante la pregunta global, el ciudadano puede ajustar sus decisiones de forma selectiva en dos bloques diferenciados:

### Bloque 1 - Datos salvo oposición
Gestiona autorizaciones cuya consulta está autorizada por defecto, pero el ciudadano puede oponerse:
- **Switch general**: Marca/desmarca todos los checkboxes del bloque
- **Checkbox individual**: Por cada autorización (marcado = SE OPONE, desmarcado = NO se opone)
- **Textarea de motivo**: Aparece cuando hay al menos una oposición marcada (obligatorio)

Si se opone a alguna autorización, debe indicar el motivo y aportar los documentos relacionados en el Paso 4.

### Bloque 2 - Datos únicamente si consiente
Gestiona autorizaciones que requieren consentimiento explícito del ciudadano:
- **Switch general**: Marca/desmarca todos los checkboxes del bloque
- **Checkbox individual**: Por cada autorización (marcado = AUTORIZA, desmarcado = NO autoriza)

Si no autoriza alguna consulta, deberá aportar los documentos relacionados en el Paso 4.

## Criterios de aceptación

### Bloque 1 - Datos salvo oposición

### CA-1: Switch general de oposiciones
**Dado** que el bloque "Datos salvo oposición" está habilitado  
**Cuando** el ciudadano activa el switch general  
**Entonces** el sistema debe marcar TODOS los checkboxes del bloque (se opone a todos)

### CA-2: Desactivar switch general de oposiciones
**Dado** que el switch general de oposiciones está activado  
**Cuando** el ciudadano lo desactiva  
**Entonces** el sistema debe desmarcar TODOS los checkboxes del bloque (no se opone a ninguno)

### CA-3: Oposición selectiva individual
**Dado** que el bloque está habilitado  
**Cuando** el ciudadano marca un checkbox individual de oposición  
**Entonces** el sistema debe registrar que se opone a esa autorización

### CA-4: Mostrar textarea de motivo
**Dado** que el ciudadano marca oposición a una o más autorizaciones  
**Cuando** marca al menos un checkbox de oposición  
**Entonces** el sistema debe mostrar un textarea con la etiqueta "Motivo de la oposición" (campo obligatorio)

### CA-5: Ocultar textarea de motivo
**Dado** que el textarea de motivo está visible  
**Cuando** el ciudadano desmarca todos los checkboxes de oposición  
**Entonces** el sistema debe ocultar el textarea de motivo

### CA-6: Validación de motivo obligatorio
**Dado** que hay al menos una autorización marcada como oposición  
**Cuando** el ciudadano intenta continuar al siguiente paso sin completar el motivo  
**Entonces** el sistema debe mostrar un mensaje de validación: "Debes indicar el motivo de la oposición"

### CA-7: Sincronización del switch de oposiciones
**Dado** que el ciudadano modifica checkboxes de oposición individuales  
**Cuando** todos los checkboxes quedan marcados  
**Entonces** el switch general debe activarse automáticamente

### Bloque 2 - Datos únicamente si consiente

### CA-8: Switch general de autorizaciones
**Dado** que el bloque "Datos únicamente si consiente" está habilitado  
**Cuando** el ciudadano activa el switch general  
**Entonces** el sistema debe marcar TODOS los checkboxes del bloque (autoriza todos)

### CA-9: Desactivar switch general de autorizaciones
**Dado** que el switch general de autorizaciones está activado  
**Cuando** el ciudadano lo desactiva  
**Entonces** el sistema debe desmarcar TODOS los checkboxes del bloque (no autoriza ninguno)

### CA-10: Autorización selectiva individual
**Dado** que el bloque está habilitado  
**Cuando** el ciudadano marca o desmarca un checkbox individual  
**Entonces** el sistema debe registrar la decisión (autoriza o no autoriza) para esa autorización específica

### CA-11: Sincronización del switch de autorizaciones
**Dado** que el ciudadano modifica checkboxes de autorización individuales  
**Cuando** todos los checkboxes quedan marcados  
**Entonces** el switch general debe activarse automáticamente

### Ambos bloques

### CA-12: Mensaje informativo
**Dado** que el ciudadano se opone o no concede alguna autorización  
**Cuando** realiza la acción  
**Entonces** debe visualizar un mensaje: "Deberás aportar la documentación cuya consulta no autorices"

### CA-13: Registro de decisiones
**Dado** que el ciudadano ha gestionado oposiciones y autorizaciones  
**Cuando** continúa con la tramitación  
**Entonces** el sistema debe registrar:
- Para cada autorización del bloque 1: si hay oposición o no
- El motivo de la oposición (si existe)
- Para cada autorización del bloque 2: si está autorizada o no

### CA-14: Documentación obligatoria
**Dado** que el ciudadano se opuso o no autorizó una o más consultas  
**Cuando** accede al paso de documentos  
**Entonces** los documentos relacionados con esas autorizaciones deben aparecer como obligatorios
