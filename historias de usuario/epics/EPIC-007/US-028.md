# US-028: Generación de PDF con código QR integrado

**Épica:** [EPIC-007](EPIC-007.md) - Presencial Ciudadanía - Proceso del Ciudadano

## Historia de usuario
**Como** ciudadano que ha guardado una solicitud presencial  
**Quiero** obtener un PDF resumen con código QR integrado  
**Para** tener un documento completo que pueda presentar en las oficinas

## Descripción funcional
Una vez guardada la solicitud presencial, el sistema genera automáticamente un PDF resumen que contiene:
- Todos los datos introducidos por el ciudadano
- Resumen de documentos aportados (si los hay)
- Autorizaciones y declaraciones seleccionadas
- Código QR integrado visualmente en el documento
- Datos textuales del código de solicitud presencial debajo del QR

El código QR se genera mediante servicio de Dokusi y contiene el identificador completo de la solicitud presencial en formato codificado. El formato del código es: `CódigoProcedimiento#digitosProcedimientoPlatea-idSolicitud` (ejemplo: 00769#07-91500).

El PDF sirve como comprobante para el ciudadano y como documento de trabajo para el tramitador. Al escanear el QR, el tramitador podrá recuperar automáticamente toda la información de la solicitud sin necesidad de introducir datos manualmente. El QR está integrado en el PDF de la solicitud.

El documento incluye marca de agua o indicación clara de que se trata de una solicitud pendiente de presentación formal, diferenciándola de una solicitud ya registrada oficialmente.

## Flujo principal
1. Sistema confirma guardado exitoso de solicitud presencial
2. Sistema obtiene código único asignado
3. Sistema genera contenido del código QR con formato establecido
4. Sistema invoca servicio de Dokusi para crear imagen del QR
5. Sistema compila datos de la solicitud presencial para el PDF
6. Sistema genera PDF con todos los datos
7. Sistema integra imagen del código QR en el PDF de la solicitud
8. Sistema añade texto del código debajo del QR en el PDF
9. Sistema marca el PDF como solicitud pendiente de presentación
10. Sistema muestra pantalla de finalización con código QR visible
11. Sistema presenta instrucciones para presentación presencial

## Criterios de aceptación

### Escenario 1: Generación automática del PDF

**Dado** que la solicitud presencial se ha guardado exitosamente  
**Cuando** el sistema confirma el guardado  
**Entonces** el sistema genera automáticamente el PDF resumen  
**Y** el PDF incluye todos los datos introducidos  
**Y** el PDF muestra código QR integrado

### Escenario 2: Formato del código QR

**Dado** que el sistema genera el código QR  
**Cuando** construye el contenido del QR  
**Entonces** el formato es CódigoProcedimiento#digitosPlatea-idSolicitudPresencial  
**Y** el código es único e irrepetible  
**Y** el QR se puede escanear correctamente

### Escenario 3: Integración del QR en el PDF

**Dado** que el sistema genera el PDF  
**Cuando** integra el código QR  
**Entonces** el QR aparece en ubicación visible y destacada  
**Y** debajo del QR aparece el código en formato texto  
**Y** el código texto coincide con el contenido codificado del QR

### Escenario 4: Invocación del servicio Dokusi

**Dado** que el sistema necesita generar el QR  
**Cuando** invoca el servicio de Dokusi  
**Entonces** el servicio devuelve imagen del QR en formato válido  
**Y** la imagen es de calidad suficiente para escaneo  

### Escenario 4.1: Gestión de error en servicio Dokusi

**Dado** que el sistema intenta generar el QR  
**Cuando** el servicio de Dokusi no está disponible  
**Entonces** el sistema no completa la finalización de la solicitud presencial  
**Y** permite al ciudadano reintentar la operación  
**Y** muestra mensaje indicando que debe reintentar

### Escenario 5: Contenido completo del PDF

**Dado** que el sistema genera el PDF resumen  
**Cuando** compila la información  
**Entonces** el PDF incluye datos de identificación del ciudadano  
**Y** el PDF incluye datos específicos del procedimiento  
**Y** el PDF lista documentos aportados  
**Y** el PDF refleja autorizaciones y declaraciones  
**Y** el PDF incluye código QR y código texto

### Escenario 6: Identificación visual de solicitud pendiente

**Dado** que el PDF se genera para solicitud presencial  
**Cuando** el sistema crea el documento  
**Entonces** el PDF incluye marca visual identificando solicitud pendiente de presentación  
**Y** se diferencia claramente de solicitudes registradas  
**Y** indica que está pendiente de presentación formal

### Escenario 7: Visualización del QR en pantalla de finalización

**Dado** que la solicitud presencial y el PDF se han generado correctamente  
**Cuando** el ciudadano accede a la pantalla de finalización  
**Entonces** el sistema muestra el código QR visualmente en pantalla  
**Y** presenta las instrucciones de presentación presencial  
**Y** ofrece opciones de descarga del PDF completo y del QR

### Escenario 8: Visualización del PDF en pantalla

**Dado** que el PDF se ha generado correctamente  
**Cuando** el ciudadano está en el paso final  
**Entonces** el sistema permite visualizar el PDF completo  
**Y** el ciudadano puede revisar la información antes de descargar

---

*Historia creada: 29/01/2026*
