# US-007: Generación de PDF justificante y envío al sistema PPS

## ID
US-007

## Título
Generación de PDF justificante y envío al sistema PPS

## Como
Ciudadano o representante

## Quiero
Que el sistema genere un justificante PDF y envíe la subsanación al sistema oficial

## Para
Obtener comprobante de la presentación y que la Administración registre oficialmente mi subsanación

## Descripción funcional

Una vez confirmado el envío, el sistema debe generar un PDF justificante con toda la información, almacenarlo en Dokusi con código QR, preparar el ejgvDocument con estructura estándar (datos de tramitación + datos de negocio), enviarlo al sistema PPS para registro oficial, gestionar reintentos ante errores, generar número de registro único, mostrar confirmación y enviar notificación por email al ciudadano.

## Flujo principal

1. Ciudadano confirma envío desde pantalla de resumen
2. Sistema muestra indicador de progreso "Generando justificante..."
3. Sistema genera PDF con información completa de la subsanación
4. Sistema almacena PDF en Dokusi y obtiene código QR
5. Sistema prepara ejgvDocument con estructura: tramitación (metadatos) + negocio (XML de datos)
6. Sistema envía ejgvDocument a PPS mediante API REST
7. PPS procesa y devuelve número de registro único
8. Sistema registra envío exitoso en auditoría
9. Sistema muestra pantalla de confirmación con número de registro, fecha/hora y botón de descarga PDF
10. Sistema envía email de confirmación al ciudadano
11. Sistema elimina borrador guardado (ya no necesario)

## Criterios de aceptación

### Escenario 1: Generación y almacenamiento de PDF justificante

**Dado** una subsanación confirmada  
**Cuando** el sistema genera el PDF  
**Entonces** incluye: título, número de expediente, procedimiento, organismo, número de registro, fecha/hora de presentación, datos de interesado y representante (si aplica), campos subsanados, documentos adjuntados (nombre, tipo y tamaño), declaraciones aceptadas con fecha/hora, pie de página legal y código QR del propio justificante  
**Y** almacena el PDF en Dokusi obteniendo identificador único y código QR

### Escenario 2: Preparación y envío exitoso de ejgvDocument

**Dado** un PDF almacenado en Dokusi  
**Cuando** el sistema prepara el ejgvDocument  
**Entonces** estructura incluye:  
**Y** Sección "tramitación": tipo de acción (Subsanación), ID expediente, ID procedimiento, ID usuario actuante, fecha/hora, datos de participantes, referencias a documentos en Dokusi  
**Y** Sección "negocio": XML con campos subsanados y declaraciones aceptadas  
**Cuando** envía a PPS mediante API REST  
**Entonces** PPS devuelve número de registro único y fecha de registro  
**Y** el sistema almacena el número de registro

### Escenario 3: Pantalla de confirmación y envío de email

**Dado** un envío exitoso a PPS  
**Cuando** el sistema muestra la confirmación  
**Entonces** presenta:  
**Y** Mensaje "Subsanación enviada correctamente"  
**Y** Número de registro y fecha/hora de presentación  
**Y** Botón "Descargar justificante PDF"  
**Y** Mensaje "Recibirás un email de confirmación"  
**Y** el sistema envía email al ciudadano con: asunto, número de registro, fecha/hora, enlace para descargar PDF e información de contacto de la Administración  
**Y** registra en auditoría: usuario, acción, expediente, número de registro, fecha/hora, IP y resultado "Exitoso"

### Escenario 4: Reintentos automáticos ante errores

**Dado** un intento de envío a PPS  
**Cuando** PPS no responde (timeout)  
**Entonces** el sistema reintenta automáticamente hasta 3 veces con intervalos de 5 segundos  
**Y** si en algún reintento PPS responde exitosamente, continúa normalmente  
**Y** registra los reintentos en logs técnicos

### Escenario 5: Errores persistentes y gestión de fallos

**Dado** un intento de generación de PDF  
**Cuando** ocurre error tras 3 reintentos  
**Entonces** muestra "No se pudo generar el justificante. Inténtalo de nuevo"  
**Y** NO procede con envío a PPS  
**Dado** un intento de envío a PPS que falla 3 veces  
**Cuando** todas las tentativas fallan  
**Entonces** muestra "No se pudo registrar la subsanación. La información ha sido guardada y el sistema reintentará automáticamente. Código de referencia: ERR-PPS-[timestamp]"  
**Y** guarda ejgvDocument localmente para reintento posterior  
**Y** registra error con código de referencia y notifica al equipo técnico

### Escenario 6: Indicador de progreso y eliminación de borrador

**Dado** un proceso de envío en curso  
**Cuando** el sistema está procesando  
**Entonces** muestra indicador con pasos: "Generando justificante..." (33%), "Almacenando documentos..." (66%), "Registrando subsanación..." (100%)  
**Y** el ciudadano NO puede navegar ni cerrar sesión durante este proceso  
**Dado** un envío exitoso  
**Cuando** el sistema procesa la confirmación  
**Entonces** elimina el borrador guardado previamente liberando espacio de almacenamiento

---

*Historia creada: 26/01/2026*  
*Última actualización: 27/01/2026*
