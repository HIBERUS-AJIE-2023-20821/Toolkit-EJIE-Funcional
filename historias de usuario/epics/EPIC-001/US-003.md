# US-003: Edición de campos requeridos para subsanación

## ID
US-003

## Título
Edición de campos requeridos para subsanación con validaciones

## Como
Ciudadano o representante

## Quiero
Editar únicamente los campos marcados como requeridos con validaciones en tiempo real

## Para
Corregir o completar la información solicitada y cumplir con el requerimiento

## Descripción funcional

El ciudadano debe poder editar exclusivamente los campos marcados para subsanación por el tramitador. El sistema debe mostrar estos campos destacados visualmente, aplicar validaciones de formato y negocio en tiempo real, mostrar valores previos del expediente como referencia, permitir guardado de borradores y bloquear el avance si hay errores. Los campos no marcados para subsanación deben mostrarse en solo lectura.

## Flujo principal

1. Sistema identifica campos marcados para subsanación desde configuración CCP
2. Sistema renderiza formulario con campos editables destacados y campos en solo lectura
3. Sistema muestra valores previos del expediente como referencia
4. Ciudadano modifica valores de campos requeridos
5. Sistema valida formato en tiempo real al perder foco y valida negocio mediante SVTs si están configurados
6. Sistema muestra errores inmediatamente bajo cada campo
7. Ciudadano puede guardar borrador manualmente en cualquier momento
8. Al hacer clic en "Guardar y continuar", sistema valida todos los campos
9. Si hay errores, bloquea avance y muestra resumen; si todo válido, guarda y avanza

## Criterios de aceptación

### Escenario 1: Validaciones de formato en tiempo real

**Dado** un campo con validación de formato (NIF, email, IBAN, etc.)  
**Cuando** el ciudadano introduce un valor y el campo pierde el foco  
**Entonces** el sistema valida inmediatamente  
**Y** muestra error descriptivo si no es válido (ej: "El NIF no es válido. Verifica la letra de control")  
**Y** marca el campo con borde rojo  
**Y** NO muestra error si el valor es correcto

### Escenario 2: Validaciones mediante SVT de terceros

**Dado** un campo con SVT configurado para validación de negocio  
**Cuando** el ciudadano introduce un valor  
**Entonces** el sistema invoca el SVT  
**Y** si el SVT devuelve error, muestra mensaje descriptivo  
**Y** bloquea el avance hasta corregir  
**Y** si el SVT no responde tras 3 reintentos, muestra error técnico y registra en logs

### Escenario 3: Campos obligatorios y valores previos del expediente

**Dado** un campo obligatorio marcado para subsanación  
**Cuando** el ciudadano deja el campo vacío o accede al formulario  
**Entonces** el sistema muestra el valor previo del expediente como referencia  
**Y** si el ciudadano deja el campo vacío e intenta avanzar, muestra error "Este campo es obligatorio"  
**Y** marca el campo con borde rojo y bloquea el avance

### Escenario 4: Guardado de borrador y coherencia entre campos

**Dado** un formulario parcialmente completado  
**Cuando** el ciudadano hace clic en "Guardar borrador"  
**Entonces** el sistema guarda el estado actual de todos los campos  
**Y** muestra confirmación "Borrador guardado correctamente"  
**Y** al regresar más tarde, los campos mantienen los valores guardados  
**Y** para campos relacionados (ej: fecha inicio/fin), valida coherencia y muestra error si no cumplen reglas

### Escenario 5: Resumen de errores y avance exitoso

**Dado** un formulario con múltiples campos requeridos  
**Cuando** el ciudadano hace clic en "Guardar y continuar" con errores  
**Entonces** el sistema muestra resumen al inicio: "Hay X errores que debes corregir"  
**Y** lista los campos con error como enlaces clickables  
**Y** bloquea el avance  
**Cuando** todos los campos son válidos  
**Entonces** el sistema guarda datos, muestra confirmación breve y avanza al siguiente paso

---

*Historia creada: 26/01/2026*  
*Última actualización: 26/01/2026*
